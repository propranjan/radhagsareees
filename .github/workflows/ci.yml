name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # ===============================
  # Code Quality & Testing
  # ===============================
  
  quality-checks:
    name: 'Quality Checks'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Environment validation
        run: pnpm run validate-env

      - name: Type checking
        run: pnpm run type-check

      - name: Linting
        run: pnpm run lint

      - name: Build packages
        run: pnpm run build

  # ===============================
  # Unit Testing & Coverage
  # ===============================

  unit-tests:
    name: 'Unit Tests & Coverage'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests with coverage
        run: pnpm run test:ci
        env:
          CI: true

      - name: Coverage threshold check
        run: |
          # Extract coverage percentages from Jest output
          COVERAGE_STATEMENTS=$(cat coverage/coverage-summary.json | jq '.total.statements.pct')
          COVERAGE_BRANCHES=$(cat coverage/coverage-summary.json | jq '.total.branches.pct')
          COVERAGE_FUNCTIONS=$(cat coverage/coverage-summary.json | jq '.total.functions.pct')
          COVERAGE_LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          
          echo "Coverage Summary:"
          echo "Statements: ${COVERAGE_STATEMENTS}%"
          echo "Branches: ${COVERAGE_BRANCHES}%"
          echo "Functions: ${COVERAGE_FUNCTIONS}%"
          echo "Lines: ${COVERAGE_LINES}%"
          
          # Check if all coverage metrics meet 80% threshold
          if (( $(echo "$COVERAGE_STATEMENTS >= 80" | bc -l) )) && \
             (( $(echo "$COVERAGE_BRANCHES >= 80" | bc -l) )) && \
             (( $(echo "$COVERAGE_FUNCTIONS >= 80" | bc -l) )) && \
             (( $(echo "$COVERAGE_LINES >= 80" | bc -l) )); then
            echo "âœ… Coverage thresholds met (â‰¥80%)"
          else
            echo "âŒ Coverage below 80% threshold"
            exit 1
          fi

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/clover.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: true

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: |
            coverage/
            !coverage/tmp
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            
            const coverageComment = `
            ## ðŸ“Š Test Coverage Report
            
            | Metric | Coverage | Status |
            |--------|----------|--------|
            | Statements | ${coverage.total.statements.pct}% | ${coverage.total.statements.pct >= 80 ? 'âœ…' : 'âŒ'} |
            | Branches | ${coverage.total.branches.pct}% | ${coverage.total.branches.pct >= 80 ? 'âœ…' : 'âŒ'} |
            | Functions | ${coverage.total.functions.pct}% | ${coverage.total.functions.pct >= 80 ? 'âœ…' : 'âŒ'} |
            | Lines | ${coverage.total.lines.pct}% | ${coverage.total.lines.pct >= 80 ? 'âœ…' : 'âŒ'} |
            
            **Total Tests:** ${coverage.total.statements.total} statements tested
            
            ${coverage.total.statements.pct >= 80 && coverage.total.branches.pct >= 80 && 
              coverage.total.functions.pct >= 80 && coverage.total.lines.pct >= 80 
              ? 'ðŸŽ‰ All coverage thresholds met!' 
              : 'âš ï¸ Some coverage metrics below 80% threshold'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: coverageComment
            });

  # ===============================
  # E2E Testing
  # ===============================

  e2e-tests:
    name: 'E2E Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: radhagsareees_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Build applications
        run: pnpm run build

      - name: Setup test database
        run: |
          pnpm run db:push
          pnpm run db:seed
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/radhagsareees_test

      - name: Run E2E tests
        run: pnpm run test:e2e
        env:
          CI: true
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/radhagsareees_test
          NEXTAUTH_SECRET: test-secret-for-ci
          NEXTAUTH_URL: http://localhost:3000

      - name: Upload E2E test results
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload E2E screenshots
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 30

  # ===============================
  # Performance Testing (Lighthouse CI)
  # ===============================

  lighthouse-ci:
    name: 'Performance Tests (Lighthouse)'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [quality-checks]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: radhagsareees_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm run build
        env:
          NODE_ENV: production
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/radhagsareees_test

      - name: Setup test database
        run: |
          pnpm run db:push
          pnpm run db:seed
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/radhagsareees_test

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: Run Lighthouse CI (Desktop)
        run: |
          # Start the server in background
          pnpm run start &
          SERVER_PID=$!
          
          # Wait for server to be ready
          npx wait-on http://localhost:3000 --timeout 60000
          
          # Run Lighthouse CI for desktop
          lhci autorun --config=lighthouse-ci.json
          
          # Kill the server
          kill $SERVER_PID
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/radhagsareees_test
          NEXTAUTH_SECRET: test-secret-for-lighthouse
          NEXTAUTH_URL: http://localhost:3000
          LHCI_BUILD_CONTEXT__CURRENT_HASH: ${{ github.sha }}
          LHCI_BUILD_CONTEXT__COMMIT_TIME: ${{ github.event.head_commit.timestamp }}

      - name: Run Lighthouse CI (Mobile)
        run: |
          # Start the server in background
          pnpm run start &
          SERVER_PID=$!
          
          # Wait for server to be ready
          npx wait-on http://localhost:3000 --timeout 60000
          
          # Run Lighthouse CI for mobile using mobile config
          lhci autorun --config=lighthouse-ci.json --preset=mobile
          
          # Kill the server
          kill $SERVER_PID
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/radhagsareees_test
          NEXTAUTH_SECRET: test-secret-for-lighthouse
          NEXTAUTH_URL: http://localhost:3000
          LHCI_BUILD_CONTEXT__CURRENT_HASH: ${{ github.sha }}
          LHCI_BUILD_CONTEXT__COMMIT_TIME: ${{ github.event.head_commit.timestamp }}

      - name: Bundle Analysis
        run: |
          # Analyze bundle sizes
          pnpm run analyze:bundle
          
          # Check bundle size constraints
          node scripts/check-bundle-size.js

      - name: Performance Budget Check
        run: |
          # Custom performance budget validation
          node scripts/performance-budget-check.js
        env:
          LIGHTHOUSE_REPORTS_DIR: .lighthouseci

      - name: Upload Lighthouse Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: lighthouse-reports
          path: .lighthouseci/
          retention-days: 30

      - name: Comment Performance Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read Lighthouse results
            const reportsDir = '.lighthouseci';
            let performanceComment = '## ðŸ“Š Performance Test Results\n\n';
            
            try {
              // Find the latest Lighthouse report
              const files = fs.readdirSync(reportsDir);
              const reportFiles = files.filter(f => f.endsWith('.json'));
              
              if (reportFiles.length > 0) {
                const latestReport = reportFiles[reportFiles.length - 1];
                const reportPath = path.join(reportsDir, latestReport);
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                
                const scores = report.categories;
                const metrics = report.audits;
                
                performanceComment += `### Performance Scores\n`;
                performanceComment += `- ðŸŽ¯ Performance: **${Math.round(scores.performance.score * 100)}/100**\n`;
                performanceComment += `- â™¿ Accessibility: **${Math.round(scores.accessibility.score * 100)}/100**\n`;
                performanceComment += `- ðŸ† Best Practices: **${Math.round(scores['best-practices'].score * 100)}/100**\n`;
                performanceComment += `- ðŸ” SEO: **${Math.round(scores.seo.score * 100)}/100**\n\n`;
                
                performanceComment += `### Core Web Vitals\n`;
                performanceComment += `- **LCP**: ${Math.round(metrics['largest-contentful-paint'].numericValue)}ms\n`;
                performanceComment += `- **FCP**: ${Math.round(metrics['first-contentful-paint'].numericValue)}ms\n`;
                performanceComment += `- **CLS**: ${metrics['cumulative-layout-shift'].numericValue.toFixed(3)}\n`;
                performanceComment += `- **TBT**: ${Math.round(metrics['total-blocking-time'].numericValue)}ms\n\n`;
                
                // Bundle size info
                const bundleSize = metrics['total-byte-weight']?.numericValue || 0;
                const jsSize = metrics['unused-javascript']?.details?.items?.reduce((sum, item) => sum + item.totalBytes, 0) || 0;
                
                performanceComment += `### Bundle Analysis\n`;
                performanceComment += `- **Total Size**: ${Math.round(bundleSize / 1024)}KB\n`;
                performanceComment += `- **JavaScript**: ${Math.round(jsSize / 1024)}KB\n\n`;
                
                // Budget status
                const lcpBudget = 2500;
                const bundleBudget = 200 * 1024; // 200KB
                
                performanceComment += `### Budget Status\n`;
                performanceComment += `- **LCP Budget**: ${metrics['largest-contentful-paint'].numericValue <= lcpBudget ? 'âœ…' : 'âŒ'} (${lcpBudget}ms target)\n`;
                performanceComment += `- **Bundle Budget**: ${jsSize <= bundleBudget ? 'âœ…' : 'âŒ'} (200KB target)\n\n`;
                
                if (metrics['largest-contentful-paint'].numericValue > lcpBudget || jsSize > bundleBudget) {
                  performanceComment += `âš ï¸ **Performance budget exceeded!** Please optimize before merging.\n\n`;
                }
                
                performanceComment += `ðŸ“Š [View detailed Lighthouse report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})\n`;
              } else {
                performanceComment += 'âŒ No Lighthouse reports found.\n';
              }
            } catch (error) {
              performanceComment += `âŒ Error reading Lighthouse reports: ${error.message}\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: performanceComment
            });

  # ===============================
  # Security Scanning
  # ===============================

  security-scan:
    name: 'Security Scan'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: pnpm audit --audit-level=moderate

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v2
        with:
          languages: javascript,typescript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  # ===============================
  # Build & Deploy (Main Branch)
  # ===============================

  build-and-deploy:
    name: 'Build & Deploy'
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [quality-checks, unit-tests, e2e-tests, security-scan]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build applications
        run: pnpm run build
        env:
          NEXT_PUBLIC_APP_URL: ${{ secrets.PRODUCTION_URL }}

      # ===============================
      # Docker Build for API
      # ===============================

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/api
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=main-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ===============================
      # Vercel Deployment
      # ===============================

      - name: Deploy to Vercel (Production)
        uses: amondnet/vercel-action@v25
        id: vercel-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./apps/web
          alias-domains: |
            radhagsareees.com
            www.radhagsareees.com

      - name: Comment deployment URL
        uses: actions/github-script@v6
        with:
          script: |
            const deploymentUrl = '${{ steps.vercel-deploy.outputs.preview-url }}';
            const deploymentComment = `
            ## ðŸš€ Deployment Successful!
            
            **ðŸŒ Production URL:** [radhagsareees.com](https://radhagsareees.com)
            **ðŸ“± Preview URL:** [${deploymentUrl}](${deploymentUrl})
            
            **ðŸ“¦ Docker Image:** \`ghcr.io/${{ github.repository }}/api:latest\`
            
            **ðŸ” Deployment Details:**
            - Commit: \`${context.sha.substring(0, 7)}\`
            - Branch: \`${context.ref.replace('refs/heads/', '')}\`
            - Workflow: [${context.runNumber}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            âœ… All quality checks passed
            âœ… Unit tests: Coverage > 80%
            âœ… E2E tests: All scenarios passed
            âœ… Security scan: No issues found
            `;
            
            // Create deployment comment on latest commit
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: deploymentComment
            });

  # ===============================
  # Preview Deployment (PRs)
  # ===============================

  preview-deploy:
    name: 'Preview Deployment'
    if: github.event_name == 'pull_request'
    needs: [quality-checks, unit-tests]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build for preview
        run: pnpm run build
        env:
          NEXT_PUBLIC_APP_URL: ${{ secrets.VERCEL_PREVIEW_URL }}

      - name: Deploy Preview to Vercel
        uses: amondnet/vercel-action@v25
        id: vercel-preview
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          github-comment: false
          working-directory: ./apps/web

      - name: Comment preview deployment
        uses: actions/github-script@v6
        with:
          script: |
            const previewUrl = '${{ steps.vercel-preview.outputs.preview-url }}';
            const previewComment = `
            ## ðŸ” Preview Deployment Ready!
            
            **ðŸ“± Preview URL:** [${previewUrl}](${previewUrl})
            
            **ðŸ§ª Test the changes:**
            - Browse the catalog and test filtering
            - Try the virtual try-on feature  
            - Test the shopping cart and checkout flow
            - Submit a product review
            
            **ðŸ”— Quick Links:**
            - [Catalog](${previewUrl}/catalog)
            - [Try-On Demo](${previewUrl}/try-on)
            - [Admin Panel](${previewUrl.replace('radhagsareees', 'admin-radhagsareees')})
            
            **ðŸ“Š Build Info:**
            - Commit: \`${context.sha.substring(0, 7)}\`
            - Branch: \`${context.payload.pull_request.head.ref}\`
            - Workflow: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            *This preview will be updated automatically when you push new commits.*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: previewComment
            });

  # ===============================
  # Cleanup & Notifications
  # ===============================

  cleanup:
    name: 'Cleanup & Notify'
    if: always()
    needs: [quality-checks, unit-tests, e2e-tests, security-scan]
    runs-on: ubuntu-latest

    steps:
      - name: Workflow Status Summary
        run: |
          echo "## ðŸ“‹ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Checks | ${{ needs.quality-checks.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.quality-checks.result }}" == "success" && \
                "${{ needs.unit-tests.result }}" == "success" && \
                "${{ needs.e2e-tests.result }}" == "success" && \
                "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **All checks passed!** Ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Some checks failed.** Please review the issues above." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify Slack on Failure
        if: failure() && github.ref == 'refs/heads/main'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          custom_payload: |
            {
              text: "ðŸš¨ CI/CD Pipeline Failed",
              attachments: [{
                color: 'danger',
                fields: [{
                  title: 'Repository',
                  value: '${{ github.repository }}',
                  short: true
                }, {
                  title: 'Branch', 
                  value: '${{ github.ref_name }}',
                  short: true
                }, {
                  title: 'Commit',
                  value: '${{ github.sha }}'.substring(0, 7),
                  short: true
                }, {
                  title: 'Author',
                  value: '${{ github.actor }}',
                  short: true
                }]
              }]
            }